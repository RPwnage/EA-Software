<project>

    <!-- convenience names -->
    <property name="modulecpp.src"      value="${package.DirtySDK.dir}/contrib/atgframework/project/${config-system}/sourcecpp.txt"      />

    <Library name="atgframework">
        <sourcefiles basedir="${package.xenonsdk.appdir}">
            <includes fromfile="${package.DirtySDK.dir}/contrib/atgframework/project/${config-system}/source.txt"/>
            <includes fromfile="${modulecpp.src}" if="@{FileExists('${modulecpp.src}')}"/>
        </sourcefiles>

        <config>
            <warningsuppression if="${config-compiler} == 'vc'">
                -wd4263
                -wd4264
                -wd4265
                -wd4296
                -wd4347
                -wd4548
                -wd4555
            </warningsuppression>
        </config>

        <buildsteps>
            <postbuild-step>
                <target hidden="true">
                    <echo message="RUNNING atgframework postbuild target" />

                    <!-- create the fonts directory -->
                    <mkdir dir="${package.builddir}\${config}\bin\media\fonts" />

                    <!-- create the help directory -->
                    <mkdir dir="${package.builddir}\${config}\bin\media\help" />

                    <!-- Convert the font file to an xpr file -->
                    <exec program="${package.xenonsdk.appdir}\bin\win32\bundler.exe" workingdir="${package.builddir}\${config}\build">
                        <arg value="${package.DirtySDK.dir}\contrib\atgframework\xdksamples\media\fonts\Arial_16.rdf"/>
                        <arg value="-o ${package.builddir}\${config}\bin\media\fonts\Arial_16.xpr"/>
                    </exec>

                    <!-- Convert the help file to an xpr file -->
                    <exec program="${package.xenonsdk.appdir}\bin\win32\bundler.exe" workingdir="${package.builddir}\${config}\build">
                        <arg value="${package.DirtySDK.dir}\contrib\atgframework\xdksamples\media\help\Help.rdf"/>
                        <arg value="-o ${package.builddir}\${config}\bin\media\help\Help.xpr"/>
                    </exec>

                    <!-- copy the media directory to the xbox 360 -->
                    <!-- It's important to use back-slashes ("\") instead of forward slashes when calling xbcp. -->
                    <!-- setting "failonerror" to false means the build will continue with the target xbox 360 off -->
                    <choose>
                        <!-- Deploy to the targets -->
                        <do if="@{PropertyExists('TargetXenon')}">
                            <foreach item="String" in="${TargetXenon}" property="DeployTarg">
                                <exec program="${package.xenonsdk.appdir}\bin\win32\xbcp.exe" failonerror="false">
                                    <arg value="/y /t /f /r /s /X:${DeployTarg}"/>
                                    <arg value="${package.builddir}\${config}\bin\media"/>
                                    <arg value="xe:\${Xenon-Dest-Dir}\media"/>
                                </exec>
                            </foreach>
                        </do>
                        <!-- This is a build, or the Target List was empty. Only deploy to default. -->
                        <do>
                            <choose>
                                <!-- BuildStudio -->
                                <do if="@{PropertyExists('Xenon-Dest-Dir')}">
                                    <exec program="${package.xenonsdk.appdir}\bin\win32\xbcp.exe" failonerror="false">
                                        <arg value="/y /t /f /r /s "/>
                                        <arg value="${package.builddir}\${config}\bin\media"/>
                                        <arg value="xe:\${Xenon-Dest-Dir}\media"/>
                                    </exec>
                                </do>
                                <!-- Continuous build -->
                                <do>
                                    <exec program="${package.xenonsdk.appdir}\bin\win32\xbcp.exe" failonerror="false">
                                        <arg value="/y /t /f /r /s "/>
                                        <arg value="${package.builddir}\${config}\bin\media"/>
                                        <arg value="xe:\${package.name}\media"/>
                                    </exec>
                                </do>
                            </choose>
                        </do>
                    </choose>
                </target>
            </postbuild-step>
        </buildsteps>

        <visualstudio>
            <post-build-step>
                ${nant.location}/nant.exe runtime.atgframework.postbuildtarget -buildfile:${nant.project.buildfile} -buildroot:${nant.project.buildroot} -masterconfigfile:${nant.project.masterconfigfile} -D:config=${config} -D:dirtysdk-samples=${dirtysdk-samples} 

                <do if="@{PropertyExists('Xenon-Dest-Dir')}">
                    -D:Xenon-Dest-Dir=${Xenon-Dest-Dir} 
                </do>

                <do if="@{PropertyExists('TargetXenon')}">
                    -D:TargetXenon=${TargetXenon}
                </do>
            </post-build-step>
        </visualstudio>
    </Library>
</project>
